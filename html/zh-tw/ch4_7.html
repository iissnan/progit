<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Gitosis - 伺服器上的 Git - Pro Git 繁體中文版</title><link rel="stylesheet" type="text/css" href="../../assets/vendor/bootstrap/dist/css/bootstrap.min.css"><link rel="stylesheet" type="text/css" href="../../assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" type="text/css" href="../../assets/vendor/nprogress/nprogress.css"><link rel="stylesheet" type="text/css" href="../../assets/css/main.css"><link rel="shortcut icon" type="images/x-icon" href="../../assets/img/favicon.ico"></head><body><a href="#main" class="sr-only">SKIP TO CONTENT</a><div id="pjax-container"><div id="header" class="navbar navbar-fixed-top navbar-inverse"><div class="container"><div class="navbar-header"><a id="brand" href="/progit/"><img src="../../assets/img/git-logo.png" alt="git" class="logo"></a><button type="button" data-toggle="collapse" data-target=".navigation" class="navbar-toggle"><span class="sr-only">Toggle Navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div class="navbar-collapse collapse navigation"><ul class="nav navbar-nav"><li class="dropdown"><a data-toggle="dropdown" href="#" class="dropdown-toggle"><span class="octicon octicon-list-unordered"></span> 目錄<b class="caret"></b></a><ul role="menu" class="dropdown-menu menu-toc"><li class="menu-toc-chapter"><a href="ch1_0.html">1   開始 </a><ul class="menu-section-links"><li><a href="ch1_1.html">1.1   關於版本控制 </a></li><li><a href="ch1_2.html">1.2   Git 的簡史 </a></li><li><a href="ch1_3.html">1.3   Git 基礎要點 </a></li><li><a href="ch1_4.html">1.4   安裝Git </a></li><li><a href="ch1_5.html">1.5   初次設定Git </a></li><li><a href="ch1_6.html">1.6   取得說明文件 </a></li><li><a href="ch1_7.html">1.7   總結 </a></li></ul></li><li class="menu-toc-chapter"><a href="ch2_0.html">2   Git 基礎 </a><ul class="menu-section-links"><li><a href="ch2_1.html">2.1   取得Git儲存庫 </a></li><li><a href="ch2_2.html">2.2   提交更新到儲存庫 </a></li><li><a href="ch2_3.html">2.3   檢視提交的歷史記錄 </a></li><li><a href="ch2_4.html">2.4   復原 </a></li><li><a href="ch2_5.html">2.5   與遠端協同工作 </a></li><li><a href="ch2_6.html">2.6   標籤 </a></li><li><a href="ch2_7.html">2.7   提示和技巧 </a></li><li><a href="ch2_8.html">2.8   總結 </a></li></ul></li><li class="menu-toc-chapter"><a href="ch3_0.html">3   Git 分支 </a><ul class="menu-section-links"><li><a href="ch3_1.html">3.1   何謂分支 </a></li><li><a href="ch3_2.html">3.2   分支的新建與合併 </a></li><li><a href="ch3_3.html">3.3   分支的管理 </a></li><li><a href="ch3_4.html">3.4   利用分支進行開發的工作流程 </a></li><li><a href="ch3_5.html">3.5   遠端分支 </a></li><li><a href="ch3_6.html">3.6   分支的衍合 </a></li><li><a href="ch3_7.html">3.7   小結 </a></li></ul></li><li class="menu-toc-chapter"><a href="ch4_0.html">4   伺服器上的 Git </a><ul class="menu-section-links"><li><a href="ch4_1.html">4.1   協議 </a></li><li><a href="ch4_2.html">4.2   在伺服器上部署 Git </a></li><li><a href="ch4_3.html">4.3   生成 SSH 公開金鑰 </a></li><li><a href="ch4_4.html">4.4   架設伺服器 </a></li><li><a href="ch4_5.html">4.5   公共訪問 </a></li><li><a href="ch4_6.html">4.6   GitWeb </a></li><li><a href="ch4_7.html">4.7   Gitosis </a></li><li><a href="ch4_8.html">4.8   Gitolite </a></li><li><a href="ch4_9.html">4.9   Git 守護進程 </a></li><li><a href="ch4_10.html">4.10   Git 託管服務 </a></li><li><a href="ch4_11.html">4.11   小結 </a></li></ul></li><li class="menu-toc-chapter"><a href="ch5_0.html">5   分散式 Git </a><ul class="menu-section-links"><li><a href="ch5_1.html">5.1   分散式工作流程 </a></li><li><a href="ch5_2.html">5.2   為專案作貢獻 </a></li><li><a href="ch5_3.html">5.3   專案的管理 </a></li><li><a href="ch5_4.html">5.4   小結 </a></li></ul></li><li class="menu-toc-chapter"><a href="ch6_0.html">6   Git 工具 </a><ul class="menu-section-links"><li><a href="ch6_1.html">6.1   選擇修訂版本 </a></li><li><a href="ch6_2.html">6.2   互動式暫存 </a></li><li><a href="ch6_3.html">6.3   儲藏 (Stashing) </a></li><li><a href="ch6_4.html">6.4   重寫歷史 </a></li><li><a href="ch6_5.html">6.5   使用 Git 做 Debug </a></li><li><a href="ch6_6.html">6.6   子模組 (Submodules) </a></li><li><a href="ch6_7.html">6.7   子樹合併 </a></li><li><a href="ch6_8.html">6.8   總結 </a></li></ul></li><li class="menu-toc-chapter"><a href="ch7_0.html">7   Git 客製化 </a><ul class="menu-section-links"><li><a href="ch7_1.html">7.1   Git 配置 </a></li><li><a href="ch7_2.html">7.2   Git 屬性 </a></li><li><a href="ch7_3.html">7.3   Git Hooks </a></li><li><a href="ch7_4.html">7.4   Git 強制策略實例 </a></li><li><a href="ch7_5.html">7.5   總結 </a></li></ul></li><li class="menu-toc-chapter"><a href="ch8_0.html">8   Git 與其他系統 </a><ul class="menu-section-links"><li><a href="ch8_1.html">8.1   Git 與 Subversion </a></li><li><a href="ch8_2.html">8.2   遷移到 Git </a></li><li><a href="ch8_3.html">8.3   總結 </a></li></ul></li><li class="menu-toc-chapter"><a href="ch9_0.html">9   Git 內部原理 </a><ul class="menu-section-links"><li><a href="ch9_1.html">9.1   底層命令 (Plumbing) 和高層命令 (Porcelain) </a></li><li><a href="ch9_2.html">9.2   Git 物件 </a></li><li><a href="ch9_3.html">9.3   Git References </a></li><li><a href="ch9_4.html">9.4   Packfiles </a></li><li><a href="ch9_5.html">9.5   The Refspec </a></li><li><a href="ch9_6.html">9.6   傳輸協議 </a></li><li><a href="ch9_7.html">9.7   維護及資料復原 </a></li><li><a href="ch9_8.html">9.8   總結 </a></li></ul></li></ul></li></ul><ul class="nav navbar-nav navbar-right"><li class="dropdown"><a data-toggle="dropdown" href="#" class="dropdown-toggle"><span class="octicon octicon-globe"></span> 其他语言<b class="caret"></b></a><ul role="menu" class="dropdown-menu"><li><a href="../../index.en.html">English</a></li><li><a href="../../index.html">简体中文</a></li><li><a href="../../index.zh-tw.html">正體中文</a></li></ul></li><li><a href="../../about.html"><span class="octicon octicon-question"></span> 關於</a></li></ul></div></div></div><div id="main" class="container"><div class="row wrap"><div class="col-md-4"><div class="ph20"> <ul class="nav sub-nav"><li class="nav-header"><a href="ch4_0.html">伺服器上的 Git</a></li><li><a href="ch4_1.html">協議</a></li><li><a href="ch4_2.html">在伺服器上部署 Git</a></li><li><a href="ch4_3.html">生成 SSH 公開金鑰</a></li><li><a href="ch4_4.html">架設伺服器</a></li><li><a href="ch4_5.html">公共訪問</a></li><li><a href="ch4_6.html">GitWeb</a></li><li><a href="ch4_7.html">Gitosis</a></li><li><a href="ch4_8.html">Gitolite</a></li><li><a href="ch4_9.html">Git 守護進程</a></li><li><a href="ch4_10.html">Git 託管服務</a></li><li><a href="ch4_11.html">小結</a></li></ul></div></div><div class="col-md-8"><div class="ph20"><h2>Gitosis</h2>

<p>把所有用戶的公開金鑰保存在 <code>authorized_keys</code> 檔的做法，只能湊和一陣子，當用戶數量達到幾百人的規模時，管理起來就會十分痛苦。每次改刪用戶都必須登錄伺服器不去說，這種做法還缺少必要的許可權管理 — 每個人都對所有專案擁有完整的讀寫許可權。</p>

<p>幸好我們還可以選擇應用廣泛的 Gitosis 項目。簡單地說，Gitosis 就是一套用來管理 <code>authorized_keys</code> 檔和實現簡單連接限制的腳本。有趣的是，用來添加用戶和設定許可權的並非通過網頁程式，而只是管理一個特殊的 Git 倉庫。你只需要在這個特殊倉庫內做好相應的設定，然後推送到伺服器上，Gitosis 就會隨之改變運行策略，聽起來就很酷，對吧？</p>

<p>Gitosis 的安裝算不上傻瓜化，但也不算太難。用 Linux 伺服器架設起來最簡單 — 以下例子中，我們使用裝有 Ubuntu 8.10 系統的伺服器。</p>

<p>Gitosis 的工作依賴於某些 Python 工具，所以首先要安裝 Python 的 setuptools 包，在 Ubuntu 上稱為 python-setuptools：</p>

<pre><code>$ apt-get install python-setuptools</code></pre>

<p>接下來，從 Gitosis 項目主頁克隆並安裝：</p>

<pre><code>$ git clone https://github.com/tv42/gitosis.git
$ cd gitosis
$ sudo python setup.py install</code></pre>

<p>這會安裝幾個供 Gitosis 使用的工具。預設 Gitosis 會把 <code>/home/git</code> 作為存儲所有 Git 倉庫的根目錄，這沒什麼不好，不過我們之前已經把項目倉庫都放在 <code>/opt/git</code> 裡面了，所以為方便起見，我們可以做一個符號連接，直接劃轉過去，而不必重新配置：</p>

<pre><code>$ ln -s /opt/git /home/git/repositories</code></pre>

<p>Gitosis 將會幫我們管理用戶公開金鑰，所以先把當前控制檔改名備份，以便稍後重新添加，準備好讓 Gitosis 自動管理 <code>authorized_keys</code> 文件：</p>

<pre><code>$ mv /home/git/.ssh/authorized_keys /home/git/.ssh/ak.bak</code></pre>

<p>接下來，如果之前把 <code>git</code> 用戶的登錄 shell 改為 <code>git-shell</code> 命令的話，先恢復 &#39;git&#39; 用戶的登錄 shell。改過之後，大家仍然無法通過該帳號登錄（譯注：因為 <code>authorized_keys</code> 檔已經沒有了。），不過不用擔心，這會交給 Gitosis 來實現。所以現在先打開 <code>/etc/passwd</code> 檔，把這行：</p>

<pre><code>git:x:1000:1000::/home/git:/usr/bin/git-shell</code></pre>

<p>改回:</p>

<pre><code>git:x:1000:1000::/home/git:/bin/sh</code></pre>

<p>好了，現在可以初始化 Gitosis 了。你可以用自己的公開金鑰執行 <code>gitosis-init</code> 命令，要是公開金鑰不在伺服器上，先臨時複製一份：</p>

<pre><code>$ sudo -H -u git gitosis-init &lt; /tmp/id_dsa.pub
Initialized empty Git repository in /opt/git/gitosis-admin.git/
Reinitialized existing Git repository in /opt/git/gitosis-admin.git/</code></pre>

<p>這樣該公開金鑰的擁有者就能修改用於配置 Gitosis 的那個特殊 Git 倉庫了。接下來，需要手工對該倉庫中的 <code>post-update</code> 腳本加上可執行許可權：</p>

<pre><code>$ sudo chmod 755 /opt/git/gitosis-admin.git/hooks/post-update</code></pre>

<p>基本上就算是好了。如果設定過程沒出什麼差錯，現在可以試一下用初始化 Gitosis 的公開金鑰的擁有者身份 SSH 登錄伺服器，應該會看到類似下面這樣：</p>

<pre><code>$ ssh git@gitserver
PTY allocation request failed on channel 0
ERROR:gitosis.serve.main:Need SSH_ORIGINAL_COMMAND in environment.
  Connection to gitserver closed.</code></pre>

<p>說明 Gitosis 認出了該用戶的身份，但由於沒有運行任何 Git 命令，所以它切斷了連接。那麼，現在運行一個實際的 Git 命令 — 克隆 Gitosis 的控制倉庫：</p>

<pre><code># 在你本地電腦上
$ git clone git@gitserver:gitosis-admin.git</code></pre>

<p>這會得到一個名為 <code>gitosis-admin</code> 的工作目錄，主要由兩部分組成：</p>

<pre><code>$ cd gitosis-admin
$ find .
./gitosis.conf
./keydir
./keydir/scott.pub</code></pre>

<p><code>gitosis.conf</code> 檔是用來設置用戶、倉庫和許可權的控制檔。<code>keydir</code> 目錄則是保存所有具有存取權限用戶公開金鑰的地方— 每人一個。在 <code>keydir</code> 裡的檔案名（比如上面的 <code>scott.pub</code>）應該跟你的不一樣 — Gitosis 會自動從使用 <code>gitosis-init</code> 腳本導入的公開金鑰尾部的描述中獲取該名字。</p>

<p>看一下 <code>gitosis.conf</code> 檔的內容，它應該只包含與剛剛克隆的 <code>gitosis-admin</code> 相關的資訊：</p>

<pre><code>$ cat gitosis.conf
[gitosis]

[group gitosis-admin]
members = scott
writable = gitosis-admin</code></pre>

<p>它顯示使用者 <code>scott</code> — 初始化 Gitosis 公開金鑰的擁有者 — 是唯一能管理 <code>gitosis-admin</code> 專案的人。</p>

<p>現在我們來添加一個新項目。為此我們要建立一個名為 <code>mobile</code> 的新段落，在其中羅列手機開發團隊的開發者，以及他們擁有寫許可權的專案。由於 &#39;scott&#39; 是系統中的唯一使用者，我們把他設為唯一用戶，並允許他讀寫名為 <code>iphone_project</code> 的新項目：</p>

<pre><code>[group mobile]
members = scott
writable = iphone_project</code></pre>

<p>修改完之後，提交 <code>gitosis-admin</code> 裡的改動，並推送到伺服器使其生效：</p>

<pre><code>$ git commit -am &#39;add iphone_project and mobile group&#39;
[master 8962da8] add iphone_project and mobile group
 1 file changed, 4 insertions(+)
$ git push origin master
Counting objects: 5, done.
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 272 bytes | 0 bytes/s, done.
Total 3 (delta 0), reused 0 (delta 0)
To git@gitserver:gitosis-admin.git
   fb27aec..8962da8  master -&gt; master</code></pre>

<p>在新工程 <code>iphone_project</code> 裡首次推送資料到伺服器前，得先設定該伺服器地址為遠端倉庫。但你不用事先到伺服器上手工創建該項目的裸倉庫— Gitosis 會在第一次遇到推送時自動創建：</p>

<pre><code>$ git remote add origin git@gitserver:iphone_project.git
$ git push origin master
Initialized empty Git repository in /opt/git/iphone_project.git/
Counting objects: 3, done.
Writing objects: 100% (3/3), 230 bytes | 0 bytes/s, done.
Total 3 (delta 0), reused 0 (delta 0)
To git@gitserver:iphone_project.git
 * [new branch]      master -&gt; master</code></pre>

<p>請注意，這裡不用指明完整路徑（實際上，如果加上反而沒用），只需要一個冒號加項目名字即可 — Gitosis 會自動幫你映射到實際位置。</p>

<p>要和朋友們在一個專案上協同工作，就得重新添加他們的公開金鑰。不過這次不用在伺服器上一個一個手工添加到 <code>~/.ssh/authorized_keys</code> 檔末端，而只需管理 <code>keydir</code> 目錄中的公開金鑰檔。文件的命名將決定在 <code>gitosis.conf</code> 中對使用者的標識。現在我們為 John，Josie 和 Jessica 添加公開金鑰：</p>

<pre><code>$ cp /tmp/id_rsa.john.pub keydir/john.pub
$ cp /tmp/id_rsa.josie.pub keydir/josie.pub
$ cp /tmp/id_rsa.jessica.pub keydir/jessica.pub</code></pre>

<p>然後把他們都加進 &#39;mobile&#39; 團隊，讓他們對 <code>iphone_project</code> 具有讀寫許可權：</p>

<pre><code>[group mobile]
members = scott john josie jessica
writable = iphone_project</code></pre>

<p>如果你提交並推送這個修改，四個用戶將同時具有該項目的讀寫許可權。</p>

<p>Gitosis 也具有簡單的存取控制功能。如果想讓 John 只有讀許可權，可以這樣做：</p>

<pre><code>[group mobile]
members = scott josie jessica
writable = iphone_project

[group mobile_ro]
members = john
readonly = iphone_project</code></pre>

<p>現在 John 可以克隆和獲取更新，但 Gitosis 不會允許他向專案推送任何內容。像這樣的組可以隨意創建，多少不限，每個都可以包含若干不同的用戶和項目。甚至還可以指定某個組為成員之一（在組名前加上 <code>@</code> 首碼），自動繼承該組的成員：</p>

<pre><code>[group mobile_committers]
members = scott josie jessica

[group mobile]
members   = @mobile_committers
writable  = iphone_project

[group mobile_2]
members   = @mobile_committers john
writable  = another_iphone_project</code></pre>

<p>如果遇到意外問題，試試看把 <code>loglevel=DEBUG</code> 加到 <code>[gitosis]</code> 的段落（譯注：把日誌設置為調試級別，記錄更詳細的運行資訊。）。如果一不小心搞錯了配置，失去了推送許可權，也可以手工修改伺服器上的 <code>/home/git/.gitosis.conf</code> 檔 — Gitosis 實際是從該檔讀取資訊的。它在得到推送資料時，會把新的 <code>gitosis.conf</code> 存到該路徑上。所以如果你手工編輯該檔的話，它會一直保持到下次向 <code>gitosis-admin</code> 推送新版本的配置內容為止。</p>

</div></div></div><div class="footer"><div class="pull-left"><span class="build-date">構建時間：2015-01-17 00:32:22</span>，<span class="build-source-version">基於書籍源碼版本：<a href="https://github.com/progit/progit/tree/6895c8264604032f24ffdee44123b922aabadf5b" target="_blank">6895c82</a></span>，<span class="application-version">程式版本：0.0.7</span>。</div><div class="pull-right">製作者<a href="http://iissnan.com" target="_blank"> iissnan</a></div></div></div></div><script src="../../assets/vendor/jquery/dist/jquery.min.js"></script><script src="../../assets/vendor/jquery-pjax/jquery.pjax.js"></script><script src="../../assets/vendor/nprogress/nprogress.js"></script><script src="../../assets/vendor/bootstrap/dist/js/bootstrap.min.js"></script><script src="../../assets/js/main.js"></script></body></html>